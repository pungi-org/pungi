version: 2.1

workflows:
  main:
    jobs:
      - shell-tests
      - install-python:
          matrix:
            parameters:
              python-version:
                - 2.7.18
                - 3.5.10
                - 3.6.13
                - 3.7.10
                - 3.8.10
                - 3.9.5
                - 3.10.0rc1
              ubuntu-version:
                - "20.04"
                - "18.04"
          requires:
            - shell-tests

orbs:
  bats: circleci/bats@1.0

commands:
  install-pyenv-deps:
    steps:
      - run:
          name: "Install pyenv Dependencies"
          command: |
            sudo apt-get update && sudo apt-get install -y \
              build-essential \
              curl \
              make \
              libbz2-dev \
              libffi-dev \
              liblzma-dev \
              libncursesw5-dev \
              libreadline-dev \
              libssl-dev \
              libsqlite3-dev \
              libxml2-dev \
              libxmlsec1-dev \
              llvm \
              tk-dev \
              wget \
              xz-utils \
              zlib1g-dev
  setup-pyenv:
    steps:
      - run:
          name: "Setup pyenv"
          command: |
            echo 'export PYENV_ROOT="$HOME/project"' >> $BASH_ENV
            echo 'export PATH="$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH"' >> $BASH_ENV
      - run: pyenv --version

jobs:
  shell-tests:
    docker:
      - image: cimg/base:2021.07
    steps:
      - checkout
      - install-pyenv-deps
      - bats/install
      - run:
          name: "Run Bats Tests"
          command: |
            sudo apt install python-is-python3
            bats test
  install-python:
    parameters:
      python-version:
        type: string
      ubuntu-version:
        type: string
    docker:
      - image: cimg/base:2021.07-<< parameters.ubuntu-version >>
    steps:
      - checkout
      - install-pyenv-deps
      - setup-pyenv
      - run:
          name: "Install and set Python version"
          command: |
            pyenv install << parameters.python-version >>
            pyenv global << parameters.python-version >>
      - run:
          name: "Showcase what we have"
          command: |
            pyenv version
            python --version
            python -m pip --version
      - when:
          condition:
            matches:
              pattern: "^3"
              value: << parameters.python-version >>
          steps:
            - run:
                name: "Test version of Python"
                command: python3 --version | grep << parameters.python-version >>
      - when:
          condition:
            matches:
              pattern: "^2"
              value: << parameters.python-version >>
          steps:
            - run:
                name: "Test version of Python"
                command: python --version | grep << parameters.python-version >>
